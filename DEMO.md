# PayKit Demo - Base Sepolia Integration

This demo showcases a complete USDC payments stack on Base Sepolia with ERC-4337 smart wallets and gas sponsorship.

## üöÄ Quick Start

### Prerequisites

- Node.js 20+
- pnpm
- Git
- Base Sepolia ETH for deployment
- Pimlico API key (optional, for bundler)

### 1. Setup Demo Environment

```bash
# Generate demo keys and environment
pnpm --filter @paykit/demo setup

# This creates:
# - apps/api/.env (API configuration)
# - .env.demo (reference copy)
```

### 2. Fund Demo Account

The setup script generates a deployer address. Fund it with Base Sepolia ETH:

1. Visit: https://www.coinbase.com/faucets/base-ethereum-sepolia-faucet
2. Enter the deployer address from setup output
3. Request testnet ETH

### 3. Install Foundry (for contracts)

```bash
curl -L https://foundry.paradigm.xyz | bash
foundryup
```

### 4. Deploy Contracts

```bash
# Option A: Manual deployment
cd contracts
source ../apps/api/.env
forge script script/Deploy.s.sol --broadcast --rpc-url $RPC_URL --private-key $PRIVATE_KEY

# Option B: Use deployment script
pnpm --filter @paykit/demo deploy-contracts
```

### 5. Start Demo

```bash
# Terminal 1: API Server
pnpm --filter @paykit/api dev

# Terminal 2: Demo Frontend
pnpm --filter @paykit/demo dev

# Visit: http://localhost:3001
```

## üéØ Demo Features

### 1. **Merchant Management**
- Connect wallet (MetaMask/Coinbase Wallet)
- Register as merchant
- Generate API keys
- Configure webhooks

### 2. **Payment Intents**
- Create payment intents via API
- EIP-712 signature verification
- Expiration handling
- Intent ID generation

### 3. **Widget Integration**
- Drop-in PayKit button
- Real-time payment states
- Error handling and retry
- Success confirmations

### 4. **Contract Interaction**
- Direct smart contract calls
- USDC vault balances
- Merchant registry lookup
- Paymaster policy validation

### 5. **Base Sepolia Integration**
- Real testnet transactions
- Block explorer links
- Gas fee estimation
- Transaction confirmation

## üìã Contract Addresses

After deployment, contracts will be available at:

```bash
# View deployed addresses
cat apps/api/.env | grep ADDRESS
```

### Mainnet-Ready Contracts

- **MerchantRegistry**: Manage merchant allowlist and fees
- **PaymentRouter**: Process payments with EIP-712 verification
- **USDCVault**: Custody merchant balances with batched payouts
- **Paymaster**: ERC-4337 gas sponsorship with policy controls
- **FeeSplitter**: Revenue distribution (placeholder)

## üß™ Testing Flows

### End-to-End Payment Test

1. **Setup**: Connect wallet, create merchant
2. **Intent**: Create $5 USDC payment intent
3. **Widget**: Use PayKit button to initiate payment
4. **Transaction**: Submit AA UserOp (currently simulated)
5. **Confirmation**: Verify payment in logs and contract

### API Endpoints Test

```bash
# Health check
curl http://localhost:4000/health

# Create merchant
curl -X POST http://localhost:4000/v1/merchants \
  -H "Content-Type: application/json" \
  -d '{"address":"0x...","name":"Test Merchant"}'

# Create payment intent
curl -X POST http://localhost:4000/v1/intents \
  -H "Content-Type: application/json" \
  -d '{"merchantId":"...","merchantAddr":"0x...","amountUsd":5.00,"ref":"ORDER-123"}'

# Configure webhook
curl -X POST http://localhost:4000/v1/webhooks/merchant \
  -H "Content-Type: application/json" \
  -d '{"merchantId":"...","webhookUrl":"https://webhook.site/unique-id"}'
```

### Contract Interaction Test

```bash
# Check merchant registration (using cast)
cast call $MERCHANT_REGISTRY_ADDRESS "isMerchant(address)" $MERCHANT_ADDRESS --rpc-url $RPC_URL

# Check USDC balance
cast call $USDC_VAULT_ADDRESS "balanceOf(address)" $MERCHANT_ADDRESS --rpc-url $RPC_URL

# View payment router domain separator
cast call $PAYMENT_ROUTER_ADDRESS "DOMAIN_SEPARATOR()" --rpc-url $RPC_URL
```

## üîß Configuration

### Environment Variables

```bash
# Chain Configuration
CHAIN_ID=84532                    # Base Sepolia
RPC_URL=https://sepolia.base.org
USDC_ADDRESS=0x036CbD53842c5426634e7929541eC2318f3dCF7e

# Keys (generated by setup)
PRIVATE_KEY=0x...                 # Deployer key
SERVER_SIGNER_PK=0x...           # EIP-712 intent signer
PAYMASTER_SIGNER_PK=0x...        # Paymaster policy signer

# Bundler (optional)
RELAYER_BUNDLER_URL=https://api.pimlico.io/v2/base-sepolia/rpc?apikey=YOUR_KEY

# Contract Addresses (set after deployment)
PAYMENT_ROUTER_ADDRESS=0x...
MERCHANT_REGISTRY_ADDRESS=0x...
USDC_VAULT_ADDRESS=0x...
PAYMASTER_ADDRESS=0x...
```

### API Configuration

```bash
# Database
DATABASE_URL=postgres://paykit:paykit@localhost:5432/paykit

# Redis (for webhooks)
REDIS_URL=redis://localhost:6379

# Server
PORT=4000
WEBHOOK_HMAC_SECRET=your_secret_key

# Frontend URLs
WEB_BASE_URL=http://localhost:3001
API_BASE_URL=http://localhost:4000
```

## üõ† Development

### Widget Development

The PayKit widget is a React component that can be embedded in any website:

```tsx
import { PayKitButton } from '@paykit/widget';

<PayKitButton
  merchantId="merchant-id"
  amountUsd={10.00}
  refId="ORDER-123"
  apiUrl="http://localhost:4000"
/>
```

### API Development

Add new routes in `apps/api/src/routes/`:

```typescript
export function registerCustomRoutes(app: any) {
  app.get('/v1/custom', async (req: any, reply: any) => {
    return reply.send({ message: 'Custom endpoint' });
  });
}
```

### Contract Development

Add new contracts in `contracts/src/` and update the deploy script.

## üîê Security Notes

### Demo vs Production

- **Demo keys are generated automatically** - never use in production
- **In-memory storage** - API uses Maps instead of database
- **Simplified validation** - production needs stricter checks
- **Mock bundler integration** - real AA UserOps need proper bundler

### Production Checklist

- [ ] Use hardware wallet for contract deployment
- [ ] Implement proper key management (HSM/KMS)
- [ ] Add rate limiting and DDoS protection  
- [ ] Implement proper database with migrations
- [ ] Add comprehensive monitoring and alerting
- [ ] Audit smart contracts before mainnet deployment
- [ ] Implement proper USDC token approvals
- [ ] Set up real bundler integration with Pimlico/Stackup
- [ ] Configure proper webhook retry logic with exponential backoff

## üìö Architecture

### Flow Diagram

```
User Wallet ‚Üí PayKit Widget ‚Üí API Server ‚Üí Smart Contracts ‚Üí Base Sepolia
    ‚Üì              ‚Üì             ‚Üì              ‚Üì
ERC-4337     Payment Intent   EIP-712      USDC Transfer
UserOp       Creation         Signing      + Fee Split
```

### Components

1. **Frontend**: React widget + demo app
2. **API**: Fastify server with route handlers
3. **Contracts**: Solidity contracts with Foundry tests  
4. **Services**: EIP-712 signing, bundler integration, webhooks
5. **Infrastructure**: Docker, CI/CD, monitoring

## ü§ù Support

For issues or questions:

1. Check the logs in the demo interface
2. Verify contract deployment on Base Sepolia explorer
3. Test API endpoints with curl
4. Review the GitHub repository for documentation

## üéâ Next Steps

After running the demo:

1. **Integrate with your app**: Use the PayKit widget
2. **Deploy to mainnet**: Update RPC and contract addresses
3. **Add custom features**: Extend the API and contracts
4. **Monitor performance**: Set up analytics and monitoring

Happy building! üöÄ 